{% extends "base.html" %}

{% block title %}Scan - Greenville Check-in{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header text-center">
                <h2>Check In</h2>
            </div>
            <div class="card-body">
                <form id="attendance-form">
                    <input type="hidden" id="token" value="{{ token }}">
                    <input type="hidden" id="site" value="{{ site }}">
                    <input type="hidden" id="device_local_id">
                    <input type="hidden" id="user_agent">
                    <input type="hidden" id="geo_lat">
                    <input type="hidden" id="geo_lon">

                    <div class="mb-3 text-center">
                        <p class="fs-5">Site: <strong>{{ site | title }}</strong></p>
                    </div>

                    <div class="d-grid">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-lg">Submit Check-in</button>
                    </div>
                    <p id="status-message" class="mt-3 text-center"></p>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function initializeForm(){
  try{
    let id = localStorage.getItem('qr_device_id');
    if(!id){
      id = (crypto.randomUUID ? crypto.randomUUID()
          : Math.random().toString(36).slice(2) + Date.now().toString(36));
      localStorage.setItem('qr_device_id', id);
    }
    document.getElementById('device_local_id').value = id;
  }catch(e){
    document.getElementById('device_local_id').value =
      Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
  document.getElementById('user_agent').value = navigator.userAgent;
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        document.getElementById('geo_lat').value = pos.coords.latitude;
        document.getElementById('geo_lon').value = pos.coords.longitude;
      },
      ()=>{}, {enableHighAccuracy:true, timeout:5000}
    );
  }
}

document.getElementById('attendance-form').addEventListener('submit', function(e){
  e.preventDefault();
  const statusMessage = document.getElementById('status-message');
  
  // Get visit reason
  const visitReason = document.getElementById('visit_reason').value;
  if (!visitReason) { 
      statusMessage.textContent='Please select a reason for visit.';
      statusMessage.style.color='red';
      return; 
  }
  
  const payload = {
    token: document.getElementById('token').value,
    site: document.getElementById('site').value,
    deviceId: document.getElementById('device_local_id').value,
    userAgent: document.getElementById('user_agent').value,
    geo: {
      lat: document.getElementById('geo_lat').value ? parseFloat(document.getElementById('geo_lat').value) : null,
      lon: document.getElementById('geo_lon').value ? parseFloat(document.getElementById('geo_lon').value) : null
    },
    nameText: null, 
    signatureDataUrl: null,
    visitReason: visitReason // --- Ensure visitReason is included ---
  };

  statusMessage.textContent = 'Submitting...'; 
  document.getElementById('submit-button').disabled = true; 

  fetch('/finalize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
    .then(r=>{ 
        if(!r.ok) { 
            // Better error handling from previous step
            r.json().then(err => { statusMessage.textContent = `Failed: ${err.detail || 'Unknown error'}`; })
              .catch(() => { statusMessage.textContent = `Failed: HTTP ${r.status}`; });
            statusMessage.style.color='red';
            throw new Error('bad response'); 
        } 
        return r.json(); 
    })
    .then((data)=>{ 
        if (data.ok === false && data.message) { 
             statusMessage.textContent = data.message;
             statusMessage.style.color = 'orange'; 
        } else {
             statusMessage.textContent='Saved!'; 
             window.location.href='/'; // Redirect home
        }
    })
    .catch((error)=>{ 
        if (error.message !== 'bad response') { 
            console.error("Fetch error:", error);
            statusMessage.textContent='Failed due to network or script error.';
            statusMessage.style.color='red';
        }
    })
    .finally(() => {
        if (statusMessage.textContent !== 'Saved!') {
            document.getElementById('submit-button').disabled = false; 
        }
    });
});

initializeForm();
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Scan - Greenville Check-in{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header text-center">
                <h2>Check In</h2>
            </div>
            <div class="card-body">
                <form id="attendance-form">
                    <input type="hidden" id="token" value="{{ token }}">
                    <input type="hidden" id="site" value="{{ site }}">
                    <input type="hidden" id="device_local_id">
                    <input type="hidden" id="user_agent">
                    <input type="hidden" id="geo_lat">
                    <input type="hidden" id="geo_lon">

                    <div class="mb-3 text-center">
                        <p class="fs-5">Site: <strong>{{ site | title }}</strong></p>
                    </div>

                    {# === ADD VISIT DROPDOWN SECTION === #}
                    <div class="mb-3"> 
                      <label for="visit_reason" class="form-label">Reason for Visit:</label>
                      <select id="visit_reason" name="visit_reason" required class="form-select">
                        <option value="" disabled selected>-- Select a Reason --</option>
                        <option value="Work">Work</option>
                        <option value="Visit">Visit</option>
                        <option value="Client Meeting">Client Meeting</option>
                        <option value="Internal Meeting">Internal Meeting</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    {# === END DROPDOWN SECTION === #}

                    {# === ADD BUSINESS LINE DROPDOWN === #}
                    <div class="mb-3">
                      <label for="business_line" class="form-label">Business Line:</label>
                      <select id="business_line" name="business_line" required class="form-select">
                        <option value="" disabled selected>-- Select Business Line --</option>
                        {# --- ADD CLIENT'S BUSINESS LINES HERE --- #}
                        <option value="Transportation">Transportation</option>
                        <option value="Buildings">Buildings</option>
                        <option value="Environment">Environment</option>
                        <option value="Water">Water</option>
                        <option value="Advisory">Advisory</option>
                        <option value="Corporate/Admin">Corporate/Admin</option>
                        <option value="N/A">N/A - Not Applicable</option>
                        {# -------------------------------------- #}
                      </select>
                    </div>
                    {# === END BUSINESS LINE DROPDOWN === #}

                    <div class="d-grid">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-lg">Submit Check-in</button>
                    </div>
                    <p id="status-message" class="mt-3 text-center"></p>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Wait for the HTML document to be fully loaded before running script
document.addEventListener('DOMContentLoaded', function() {

    // --- Your existing functions go inside ---
    function initializeForm(){
      try{
        let id = localStorage.getItem('qr_device_id');
        if(!id){
          id = (crypto.randomUUID ? crypto.randomUUID()
                : Math.random().toString(36).slice(2) + Date.now().toString(36));
          localStorage.setItem('qr_device_id', id);
        }
        // Ensure element exists before accessing value - belt and braces
        const deviceIdInput = document.getElementById('device_local_id');
        if (deviceIdInput) deviceIdInput.value = id;
      }catch(e){
        const deviceIdInput = document.getElementById('device_local_id');
        if (deviceIdInput) deviceIdInput.value = Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      // Ensure element exists before accessing value
      const userAgentInput = document.getElementById('user_agent');
      if (userAgentInput) userAgentInput.value = navigator.userAgent;

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const latInput = document.getElementById('geo_lat');
            const lonInput = document.getElementById('geo_lon');
            if (latInput) latInput.value = pos.coords.latitude;
            if (lonInput) lonInput.value = pos.coords.longitude;
          },
          ()=>{}, {enableHighAccuracy:true, timeout:5000}
        );
      }
    }

    const form = document.getElementById('attendance-form');
    // Ensure form exists before adding listener
    if (form) {
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const statusMessage = document.getElementById('status-message');
          const visitReasonSelect = document.getElementById('visit_reason'); // Get reason select element
          const businessLineSelect = document.getElementById('business_line'); // Get Business Line element

          // --- GET VISIT REASON ---
          const visitReason = visitReasonSelect ? visitReasonSelect.value : null; // Check if element exists
          const businessLine = businessLineSelect ? businessLineSelect.value : null; // Get selected Business Line

          if (!visitReason) { // Basic validation
              if (statusMessage) { // Check if status message element exists
                statusMessage.textContent='Please select a reason for visit.';
                statusMessage.style.color='red';
              }
              return;
          }
          // -------------------------

          // --- GET VISIT REASON ---
          if (!businessLine) { // Basic validation
              if (statusMessage) { // Check if status message element exists
                statusMessage.textContent='Please select a business line.';
                statusMessage.style.color='red';
              }
              return;
          }
          // -------------------------

          // Safely get values, checking if elements exist
          const payload = {
            token: document.getElementById('token')?.value || '',
            site: document.getElementById('site')?.value || '',
            deviceId: document.getElementById('device_local_id')?.value || null,
            userAgent: document.getElementById('user_agent')?.value || null,
            geo: {
              lat: document.getElementById('geo_lat')?.value ? parseFloat(document.getElementById('geo_lat').value) : null,
              lon: document.getElementById('geo_lon')?.value ? parseFloat(document.getElementById('geo_lon').value) : null
            },
            nameText: null,
            signatureDataUrl: null,
            visitReason: visitReason, // --- INCLUDE VISIT REASON ---
            businessLine: businessLine // --- INCLUDE BUSINESS LINE ---
          };

          // --- ADD THIS LINE ---
          console.log("Payload being sent:", JSON.stringify(payload)); 
          // ---------------------

          if (statusMessage) statusMessage.textContent = 'Submitting...';
          const submitButton = document.getElementById('submit-button');
          if (submitButton) submitButton.disabled = true;

          fetch('/finalize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
            .then(r=>{
                if(!r.ok) {
                    r.json().then(err => {
                       if (statusMessage) statusMessage.textContent = `Failed: ${err.detail || 'Unknown error'}`;
                    }).catch(() => {
                       if (statusMessage) statusMessage.textContent = `Failed: HTTP ${r.status}`;
                    });
                    if (statusMessage) statusMessage.style.color='red';
                    throw new Error('bad response');
                }
                return r.json();
            })
            .then((data)=>{
                if (data.ok === false && data.message) {
                     if (statusMessage) {
                         statusMessage.textContent = data.message;
                         statusMessage.style.color = 'orange';
                     }
                } else {
                     if (statusMessage) statusMessage.textContent='Saved!';
                     window.location.href='/'; // Redirect home
                }
            })
            .catch((error)=>{
                if (error.message !== 'bad response') {
                    console.error("Fetch error:", error);
                    if (statusMessage) {
                        statusMessage.textContent='Failed due to network or script error.';
                        statusMessage.style.color='red';
                    }
                }
            })
            .finally(() => {
                if (statusMessage && statusMessage.textContent !== 'Saved!') {
                    if (submitButton) submitButton.disabled = false;
                }
            });
        });
    } // End if (form)

    // Call initializeForm after DOM is loaded
    initializeForm();
    // ------------------------------------------

}); // End DOMContentLoaded listener
</script>
{% endblock %}

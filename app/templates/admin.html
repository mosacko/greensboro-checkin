{% extends "base.html" %}

{% block title %}Admin Dashboard - Calendar View{% endblock %}

{% block content %}
    <h1 class="mb-3">Attendance Calendar</h1>
    <div class="logout mb-4"><a href="/admin/logout">Logout</a></div>

    {# --- Main Row: Calendar and Side Panel Placeholder --- #}
    <div class="row">
        {# Calendar Area #}
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Calendar View</h2>
                </div>
                <div class="card-body">
                    {# Div where FullCalendar will render #}
                    <div id='calendar'></div> 
                </div>
            </div>
        </div>

        {# Side Panel Area - Placeholder and Offcanvas Definition #}
        <div class="col-md-4">
            {# Placeholder shown initially #}
            <div class="card mb-4" id="sidePanelPlaceholder">
                <div class="card-header">
                    <h5 class="mb-0">Daily Summary</h5>
                </div>
                <div class="card-body text-center text-muted">
                    <p>Click a date on the calendar to view check-ins for that day.</p>
                </div>
            </div>

             {# Offcanvas Definition (Hidden until triggered by calendar click) #}
            <div class="offcanvas offcanvas-end" tabindex="-1" id="attendanceOffcanvas" aria-labelledby="attendanceOffcanvasLabel">
              <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title" id="attendanceOffcanvasLabel">Check-ins</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
              </div>
              <div class="offcanvas-body">
                <ul class="list-group list-group-flush" id="attendanceList">
                  {# List items will be added here by JavaScript #}
                  <li class="list-group-item">Loading...</li>
                </ul>
              </div>
            </div>
        </div>
    </div>{# --- End Main Row --- #}


    {# --- All Records Table Card --- #}
    <div class="card mt-4">
        <div class="card-header">
             <h2>All Records (Raw Data)</h2>
        </div>
        <div class="card-body">
             <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered caption-top">
                    <caption>List of all check-in records</caption>
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Timestamp</th>
                            <th>Site</th>
                            <th>Event Type</th>
                            <th>User Name</th>
                            <th>Reason</th>
                            <th>Device ID</th>
                            <th>Geo (Lat, Lon)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rec in all_records %} {# Assumes all_records is passed from main.py #}
                        <tr>
                            <td>{{ rec.id }}</td>
                            <td>{{ rec.timestamp_display }}</td> {# Use pre-formatted time #}
                            <td>{{ rec.site | title }}</td>
                            <td>{{ rec.event_type }}</td>
                            <td>{{ rec.user_name or 'N/A' }}</td>
                            <td>{{ rec.visit_reason or 'N/A' }}</td>
                            <td>{{ rec.device_local_id or 'N/A' }}</td>
                            <td>
                                {% if rec.geo_lat and rec.geo_lon %}
                                    {{ "%.4f"|format(rec.geo_lat) }}, {{ "%.4f"|format(rec.geo_lon) }}
                                {% else %} N/A {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center fst-italic">No records found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
        </div>
    </div>
    {# --- END All Records Card --- #}

{% endblock %} {# End Content Block #}

{% block scripts %} {# Scripts Block (at end of body) #}
    {# Include FullCalendar JS #}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    {# Chart.js is not needed for this layout, can remove if desired #}
    {# <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> #}

    <script>
      // Wait for the DOM to be ready
      document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const offcanvasElement = document.getElementById('attendanceOffcanvas');
        const offcanvasTitle = document.getElementById('attendanceOffcanvasLabel');
        const attendanceList = document.getElementById('attendanceList');
        const sidePanelPlaceholder = document.getElementById('sidePanelPlaceholder');
        
        // Ensure Bootstrap Offcanvas is initialized
        // Note: Bootstrap JS should be loaded in base.html for this to work
        const attendanceOffcanvas = new bootstrap.Offcanvas(offcanvasElement); 

        // --- Initialize FullCalendar ---
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth', 
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek' // Added list view
          },
          editable: false, 
          selectable: false, 
          
          // --- Handle Date Click ---
          dateClick: async function(info) {
            const dateStr = info.dateStr;
            console.log('Date clicked: ' + dateStr);

            offcanvasTitle.textContent = `Check-ins for ${dateStr}`;
            attendanceList.innerHTML = '<li class="list-group-item">Loading...</li>'; 
            // sidePanelPlaceholder.style.display = 'none'; // Keep placeholder visible behind offcanvas
            attendanceOffcanvas.show(); 

            try {
              const response = await fetch(`/api/metrics/attendance/${dateStr}`);
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              const records = await response.json();

              attendanceList.innerHTML = ''; // Clear loading/previous

              if (records.length === 0) {
                attendanceList.innerHTML = '<li class="list-group-item fst-italic text-muted">No check-ins found for this date.</li>';
              } else {
                records.forEach(rec => {
                  const listItem = document.createElement('li');
                  listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                  let timeStr = 'N/A';
                  if (rec.timestamp_utc) {
                      try { timeStr = new Date(rec.timestamp_utc).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); } 
                      catch(e) { console.error("Error formatting date:", e); }
                  }
                  listItem.innerHTML = `
                    <span>
                      <strong>${rec.user_name || 'Unknown User'}</strong>
                      <small class="text-muted ms-2">(${rec.site ? rec.site.charAt(0).toUpperCase() + rec.site.slice(1) : 'N/A'})</small>
                      <small class="text-muted ms-2 fst-italic">[${rec.visit_reason || 'N/A'}]</small>
                    </span>
                    <span class="badge bg-secondary rounded-pill">${timeStr}</span>`;
                  attendanceList.appendChild(listItem);
                });
              }
            } catch (error) {
              console.error("Could not fetch attendance data:", error);
              attendanceList.innerHTML = '<li class="list-group-item text-danger">Error loading data.</li>';
            }
          } // --- End Date Click Handler ---
          
        }); // End Calendar initialization

        calendar.render();

      }); // End DOMContentLoaded
    </script>
{% endblock %} {# End Scripts Block #}